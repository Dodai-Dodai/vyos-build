name: build-vyos-qcow2

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag name or version to use for the release (e.g., 1.5.0)'
        required: false
      publish_release:
        description: 'Publish artifacts to GitHub Releases (set to false for dry runs)'
        required: false
        default: 'true'
      skip_build:
        description: 'Skip the heavy VyOS build (for validation/testing only)'
        required: false
        default: 'false'
  push:
    tags:
      - 'v*'
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 240
    env:
      FLAVOR_NAME: pve-cloudinit
      VYOS_SOURCE_DIR: vyos-build-src
      FLAVOR_FILE: data/build-flavors/pve-cloudinit.toml
      SKIP_BUILD: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.skip_build == 'true' }}
    outputs:
      has_artifact: ${{ steps.artifact_status.outputs.has_artifact }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone upstream vyos-build sources
        run: |
          git clone --depth 1 https://github.com/vyos/vyos-build "${VYOS_SOURCE_DIR}"

      - name: Write flavor for Proxmox + cloud-init
        run: |
          mkdir -p "${VYOS_SOURCE_DIR}/$(dirname "${FLAVOR_FILE}")"
          cat > "${VYOS_SOURCE_DIR}/${FLAVOR_FILE}" <<'TOML'
          image_format = "qcow2"
          packages = ["cloud-init", "qemu-guest-agent"]
          default_config = '''
          system { host-name vyos; console { device ttyS0 { speed 115200 } } login { user vyos { authentication {
            encrypted-password $6$QxPS.uk6mfo$9QBSo8u1FkH16gMyAVhus6fU3LOzvLR9Z9.82m3tiHFAxTtIkhaZSWssSgzt4v4dGAL8rhVQxTg0oAG9/q11h/ ; plaintext-password "" } } } }
          interfaces { loopback lo {} }'''
          [[includes_chroot]]
          path = "etc/cloud/cloud.cfg.d/90_datasource.cfg"
          data = "datasource_list: [NoCloud, ConfigDrive]"
          [boot_settings]
          timeout = 5
          console_type = "ttyS"
          console_num = 0
          console_speed = 115200
          TOML

      - name: Build VyOS qcow2 image
        if: env.SKIP_BUILD != 'true'
        run: |
          sudo docker run --rm --privileged \
            -v "$PWD":/vyos -v /dev:/dev -w /vyos/${VYOS_SOURCE_DIR} \
            vyos/vyos-build:current bash -lc "
              set -euo pipefail
              sudo ./build-vyos-image ${FLAVOR_NAME}
            "

      - name: Collect qcow2 artifact
        if: env.SKIP_BUILD != 'true'
        run: |
          mkdir -p dist
          shopt -s nullglob
          for image in ${VYOS_SOURCE_DIR}/build/vyos-*-${FLAVOR_NAME}-amd64.qcow2; do
            cp "$image" dist/
          done
          ls -lh dist || true

      - name: Ensure dist directory exists
        run: mkdir -p dist

      - name: Determine artifact availability
        id: artifact_status
        run: |
          if compgen -G "dist/*.qcow2" > /dev/null; then
            echo "has_artifact=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_artifact=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload qcow2 artifact (24h retention)
        if: steps.artifact_status.outputs.has_artifact == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: vyos-qcow2-${{ env.FLAVOR_NAME }}
          path: dist/*.qcow2
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ needs.build.outputs.has_artifact == 'true' && (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.publish_release != 'false')) }}
    env:
      FLAVOR_NAME: pve-cloudinit
    steps:
      - name: Download qcow2 artifact
        uses: actions/download-artifact@v4
        with:
          name: vyos-qcow2-pve-cloudinit
          path: dist

      - name: Extract image version from artifact name
        id: image_meta
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(dist/*.qcow2)
          if [ ${#files[@]} -eq 0 ]; then
            echo "::error::No qcow2 artifacts found in dist/" >&2
            exit 1
          fi

          image="${files[0]}"
          image_base="$(basename "$image")"
          version="${image_base#vyos-}"
          version="${version%-${FLAVOR_NAME}-amd64.qcow2}"

          if [ -z "$version" ] || [ "$version" = "$image_base" ]; then
            echo "::error::Unable to derive version from artifact name '$image_base'" >&2
            exit 1
          fi

          echo "image_name=$image_base" >> "$GITHUB_OUTPUT"
          echo "version=$version" >> "$GITHUB_OUTPUT"

      - name: Resolve release metadata
        id: release_meta
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_VERSION: ${{ github.event.inputs.version }}
          DERIVED_VERSION: ${{ steps.image_meta.outputs.version }}
        run: |
          if [ "$EVENT_NAME" = "workflow_dispatch" ]; then
            version="${INPUT_VERSION:-$DERIVED_VERSION}"
            if [ -z "$version" ]; then
              echo "::error::Unable to resolve version for release metadata" >&2
              exit 1
            fi
            echo "tag=$version" >> "$GITHUB_OUTPUT"
            echo "release_name=VyOS $version (qcow2)" >> "$GITHUB_OUTPUT"
          else
            echo "tag=$GITHUB_REF_NAME" >> "$GITHUB_OUTPUT"
            echo "release_name=VyOS $GITHUB_REF_NAME (qcow2)" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_meta.outputs.tag }}
          name: ${{ steps.release_meta.outputs.release_name }}
          files: dist/*.qcow2
          generate_release_notes: true
          make_latest: true
